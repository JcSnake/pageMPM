const NOTIFY_STS = { primary: 'primary', success: 'success', danger: 'danger', warning: 'warning' }
const NOTIFY_POS = { center: 'top-center', left: 'top-left', right: 'top-right' }
const expression = /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;

$(document).ready(() => {
    adjustInfoBlock();
    adjustNav();
    setListeners();

    if ('ontouchstart' in document.documentElement) {

    }

    validarParametros();
});

$(window).resize(() => {
    adjustInfoBlock();
    adjustNav();
});

$(window).scroll(e => {
    if (window.pageYOffset > 500) {
        $('.mp-btn-top').css('display', 'inline');
    } else {
        $('.mp-btn-top').css('display', 'none');
    }
});

function adjustInfoBlock() {
    $('.mp-info-block').each(function () {
        this.style.height = this.offsetWidth + 'px';
    });
}

function adjustNav() {
    var width = ($('#mpNav')[0].offsetWidth - ($('.mp-nav-icon')[0].offsetWidth * $('.mp-nav-icon').length)) / $('.mp-nav-li').length - 1;

    $('.mp-nav-li').each(function() {
        this.style.width = `${width}px`;
    });
}

function setListeners() {
    $('#btnPayWithPayPal').click(payPalModal);

    var frmPayPal = $('#frmPayPal')[0];
    if (frmPayPal !== undefined) {
        for (var i = 1; i < frmPayPal.length; i++) {
            $(frmPayPal[i]).change((e) => {
                e.target.classList.remove('uk-form-danger');
                e.target.classList.remove('uk-form-success')
            });
        }
    }

    changeNavIcons();

    $('#btnSendCV').click(enviarCV);
    $('#btnContacto').click(enviarRegistro);

    $('button[data-mp-set-categoria]').click(e => {
        setCalendario(e.target);
    });

    $('[data-mp-curso-info]').click(function() {
        window.location.href = `curso.php?curso=${$(this).data('mpCursoInfo')}`;
    }).each(function() {
        this.style.cursor = 'pointer';
    });
}

function presentNotification(msg, status = NOTIFY_STS.success, pos = NOTIFY_POS.center, timeout = 3000) {
    UIkit.notify({
        message: msg,
        status: status,
        pos: pos,
        timeout: timeout
    });
}

function clearFrm(frm, cleanValue = false) {
    var objElements = (type = 'input') => $('#' + frm.id + ' ' + type);

    var clear = e => {
        try {
            if (cleanValue) {
                e.tagName == "SELECT" ? e.value = e.options[0].value : e.value = '';
            }

            e.classList.remove('uk-form-success');
            e.classList.remove('uk-form-danger');
        } catch (e) { }
    }

    var inputs = Array.from(Object.keys(objElements()), k => objElements()[k]);
    var selects = Array.from(Object.keys(objElements('select')), k => objElements('select')[k]);
    var textareas = Array.from(Object.keys(objElements('textarea')), k => objElements('textarea')[k]);

    inputs.forEach(e => clear(e));
    selects.forEach(e => clear(e));
    textareas.forEach(e => clear(e));
}

function payPalModal() {
    function finishPayPal() {
        $('#closeModalPaypal').trigger('click');
        clearFrm($('#frmPayPal')[0], true);
    }

    if (valPayPalFrm()) {
        UIkit.modal.confirm('Esta apunto de dirigirse al sitio de PayPal<sup>&reg;</sup> para realizar el pago. ¿Deseá continuar?', () => {
            sendPayPal();
            finishPayPal();
        }, () => {
            finishPayPal();
        });
    } else {
        presentNotification('No ha completado los datos correctamente. Por favor revise que los datos se encuentre correctos e intente de nuevo.', NOTIFY_STS.warning);
    }
}

function valPayPalFrm() {
    var frm = $('#frmPayPal')[0];
    var validate = true;

    function setStyle(e, fail) {
        if (fail) { validate = false; }
        e.classList.add(fail ? 'uk-form-danger' : 'uk-form-success');
    }

    if (frm !== undefined) {
        clearFrm(frm);
        setStyle(frm.quantity, frm.quantity.value === "" || frm.quantity.value < 1);
        setStyle(frm.product, frm.product.value === "0");
        setStyle(frm.amountPayable, frm.amountPayable.value === "" || frm.amountPayable.value < 0);
    }

    return validate;
}

function sendPayPal() {
    var frmPayPal = $('#frmPayPal')[0];
    var frmPay = $('#frmPay')[0];

    if (frmPayPal !== undefined && frmPay !== undefined) {
        frmPay.os0.value = frmPayPal.seller.value;
        frmPay.os1.value = frmPayPal.product.options[frmPayPal.product.selectedIndex].text;
        frmPay.item_name.value = frmPayPal.product.options[frmPayPal.product.selectedIndex].text;
        frmPay.amount.value = frmPayPal.amountPayable.value * frmPayPal.quantity.value;
        frmPay.currency_code.value = frmPayPal.currency.value;

        frmPay.submit();
    }
}

function changeNavIcons() {
    $(".mp-image-container").mouseover(function () {
        $(this).attr('src', $(this).data("hover"));
    }).mouseout(function () {
        $(this).attr('src', $(this).data("src"));
    });
}

function enviarCV() {
    if (validarCV()) {
        UIkit.modal.blockUI('Enviando CV, por favor espere...')
        $('#frmBolsa').submit();
    } else {
        UIkit.notify('Los datos ingresados son incorrectos favor de verificar.', 'danger');
    }
}

function enviarRegistro() {
    if (validarFrmContacto()) {
        var frm = $('#frmContacto')[0];

        $.ajax({
            timeout: 60000,
            url: '/mx/resources/libs/registro.php',
            method: 'POST',
            data: `nombre=${frm.nombre.value}&apellido=${frm.apellido.value}&telefono=${frm.telefono.value}&correo=${frm.correo.value}&curso=${frm.curso.value}&mensaje=${frm.mensaje.value}`,
            beforeSend: () => {
                modal = UIkit.modal.blockUI('Se esta enviando el mensaje por favor espere.');
            },
            success: response => {
                try {
                    var data = JSON.parse(response);

                    if(data.success) {
                        UIkit.notify('Se registro correctamente tus gracias por contactarnos.', 'success');
                    } else {
                        UIkit.notify('No se pudieron registrar tus datos, intenta nuevamente más tarde.', 'danger');
                    }

                    $('#formulario').addClass('uk-hidden');
                    $('#mensaje').removeClass('uk-hidden');
                } catch(e) {
                    console.log(e);
                    UIkit.notify('Ocurrio un problema con tu registro. Intenta más tarde.');
                }

                modal.hide();
            }, error: (xhr, status, error) => {
                console.log(error);
                modal.hide();
                UIkit.notify('Se generó un problema al tratar de registrar tus datos, por favor intenta más tarde.', 'danger');
            }
        });
    } else {
        UIkit.notify('Los datos ingresados son incorrectos favor de verificar.', 'danger');
    }
}

function validarCV() {
    var frm = $('#frmBolsa')[0];
    var validado = true;

    limpiarInput(frm.name);
    limpiarInput(frm.phone);
    limpiarInput(frm.email);
    limpiarInput(frm.cv);

    if (frm.name.value.length <= 5) {
        validado = false;
        frm.name.classList.add('uk-form-danger');
    } else {
        frm.name.classList.add('uk-form-success');
    }

    if (frm.phone.value.length < 10) {
        validado = false;
        frm.phone.classList.add('uk-form-danger');
    } else {
        frm.phone.classList.add('uk-form-success');
    }

    if (!expression.test(frm.email.value)) {
        validado = false;
        frm.email.classList.add('uk-form-danger');
    } else {
        frm.email.classList.add('uk-form-success');
    }

    if (frm.cv.files.length == 0 || ((frm.cv.files[0].size / 1000) / 1000) > 2) {
        validado = false;
        frm.cv.classList.add('uk-form-danger');
    } else {
        frm.cv.classList.add('uk-form-success');
    }

    return validado;
}

function limpiarInput(inp) {
    inp.classList.remove('uk-form-danger');
    inp.classList.remove('uk-form-success');
}

function validarParametros() {
    if (window.location.search.substr(1) != '') {
        var parametros = {};

        window.location.search.substr(1).split('&').forEach(param => {
            var tmp = param.split('=');
            parametros[tmp[0]] = tmp[1];
        });

        if (parametros.sCV != undefined) {
            UIkit.modal('#modalBolsa').show();
        }
    }
}

function setCalendario(target) {
    $('tr[data-mp-categoria]').each((i, e) => {
        e.classList.remove('uk-hidden');
        if ($(e).data('mpCategoria') != $(target).data('mpSetCategoria')) e.classList.add('uk-hidden');
    });
}

function validarFrmContacto() {
    var frm = $('#frmContacto')[0];
    var validado = true;

    if (frm.nombre.value.length <= 5) {
        validado = false;
        frm.nombre.classList.add('uk-form-danger');
    } else {
        frm.nombre.classList.add('uk-form-success');
    }

    if (frm.apellido.value.length <= 5) {
        validado = false;
        frm.apellido.classList.add('uk-form-danger');
    } else {
        frm.apellido.classList.add('uk-form-success');
    }

    if (frm.telefono.value.length < 10) {
        validado = false;
        frm.telefono.classList.add('uk-form-danger');
    } else {
        frm.telefono.classList.add('uk-form-success');
    }

    if (!expression.test(frm.correo.value)) {
        validado = false;
        frm.correo.classList.add('uk-form-danger');
    } else {
        frm.correo.classList.add('uk-form-success');
    }

    if (frm.curso.value == '') {
        validado = false;
        frm.curso.classList.add('uk-form-danger');
    } else {
        frm.curso.classList.add('uk-form-success');
    }

    if (frm.mensaje.value.length < 10) {
        validado = false;
        frm.mensaje.classList.add('uk-form-danger')
    } else {
        frm.mensaje.classList.add('uk-form-success')
    }

    return validado;
}